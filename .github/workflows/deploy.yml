name: ğŸš€ Deploy Modern Spreadsheet

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  # main ë¸Œëœì¹˜ì— pushë  ë•Œ
  push:
    branches: [main, master]

  # Pull Requestê°€ main ë¸Œëœì¹˜ë¡œ ì˜¬ ë•Œ
  pull_request:
    branches: [main, master]

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

# Job ì •ì˜
jobs:
  # 1. íŒŒì¼ ê²€ì¦ ë° ë¹Œë“œ
  build-and-deploy:
    name: ğŸ—ï¸ Build and Deploy
    runs-on: ubuntu-latest

    # GitHub Pages ë°°í¬ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: read
      pages: write
      id-token: write

    # ë°°í¬ í™˜ê²½ ì„¤ì • (main ë¸Œëœì¹˜ë§Œ)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Verify required files
        run: |
          echo "ğŸ” Checking required files..."
          if [ ! -f "index.html" ]; then
            echo "âŒ index.html not found!"
            exit 1
          fi
          if [ ! -f "styles.css" ]; then
            echo "âŒ styles.css not found!"
            exit 1
          fi
          if [ ! -f "app.js" ]; then
            echo "âŒ app.js not found!"
            exit 1
          fi
          echo "âœ… All required files found!"

      - name: ğŸ“Š Show file sizes
        run: |
          echo "ğŸ“Š File sizes:"
          ls -lh *.html *.css *.js 2>/dev/null || echo "Some files may be missing"
          echo ""
          echo "ğŸ“ˆ Total project size:"
          du -sh . 2>/dev/null || echo "Could not calculate size"

      - name: ğŸ” Basic HTML validation
        run: |
          echo "ğŸ” Checking HTML structure..."
          if grep -q "<!DOCTYPE html>" index.html; then
            echo "âœ… DOCTYPE found"
          else
            echo "âš ï¸ DOCTYPE not found"
          fi

          if grep -q "<title>" index.html; then
            echo "âœ… Title tag found"
          else
            echo "âš ï¸ Title tag not found"
          fi

          if grep -q "styles.css" index.html; then
            echo "âœ… CSS linked"
          else
            echo "âš ï¸ CSS not linked"
          fi

          if grep -q "app.js" index.html; then
            echo "âœ… JavaScript linked"
          else
            echo "âš ï¸ JavaScript not linked"
          fi

      - name: ğŸ” Basic CSS validation
        run: |
          echo "ğŸ” Checking CSS structure..."
          if [ -f "styles.css" ]; then
            css_size=$(wc -c < styles.css)
            echo "ğŸ“ CSS file size: $css_size bytes"
            
            if grep -q "body" styles.css; then
              echo "âœ… Body styles found"
            fi
            
            if grep -q "@media" styles.css; then
              echo "âœ… Responsive design detected"
            fi
          fi

      - name: ğŸ” Basic JavaScript validation
        run: |
          echo "ğŸ” Checking JavaScript structure..."
          if [ -f "app.js" ]; then
            js_size=$(wc -c < app.js)
            echo "ğŸ“ JavaScript file size: $js_size bytes"
            
            if grep -q "function" app.js; then
              echo "âœ… Functions found"
            fi
            
            if grep -q "addEventListener" app.js; then
              echo "âœ… Event listeners found"
            fi
            
            if grep -q "document.getElementById" app.js; then
              echo "âœ… DOM manipulation found"
            fi
          fi

      - name: ğŸ“¦ Create deployment directory
        run: |
          echo "ğŸ“¦ Preparing files for deployment..."
          mkdir -p dist
          cp index.html dist/
          cp styles.css dist/
          cp app.js dist/

          # READMEê°€ ìˆìœ¼ë©´ ë³µì‚¬
          if [ -f "README.md" ]; then
            cp README.md dist/
          fi

          echo "âœ… Files copied to dist directory"
          echo "ğŸ“‚ Deployment contents:"
          ls -la dist/

      - name: ğŸ“„ Setup GitHub Pages
        uses: actions/configure-pages@v4
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

      - name: ğŸ”§ Enable Pages if not enabled
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          echo "ğŸ“„ Checking GitHub Pages status..."
          echo "If this step fails, please enable GitHub Pages manually in repository settings"
          echo "Go to: Settings > Pages > Source > GitHub Actions"

      - name: ğŸ“¤ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        with:
          path: ./dist

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/deploy-pages@v4

  # 2. ë°°í¬ í›„ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ì„ íƒì )
  performance-check:
    name: ğŸ“Š Performance Check
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ğŸ“Š Install and run basic performance check
        run: |
          echo "ğŸ“Š Running basic performance analysis..."

          # íŒŒì¼ í¬ê¸° ë¶„ì„
          html_size=$(wc -c < index.html)
          css_size=$(wc -c < styles.css)
          js_size=$(wc -c < app.js)
          total_size=$((html_size + css_size + js_size))

          echo "ğŸ“ File Size Analysis:"
          echo "  HTML: ${html_size} bytes"
          echo "  CSS:  ${css_size} bytes"
          echo "  JS:   ${js_size} bytes"
          echo "  Total: ${total_size} bytes"

          # ì„±ëŠ¥ ê¶Œì¥ì‚¬í•­
          echo ""
          echo "ğŸ“‹ Performance Recommendations:"

          if [ $total_size -gt 1000000 ]; then
            echo "âš ï¸  Total size > 1MB - Consider optimization"
          else
            echo "âœ… Total size is reasonable"
          fi

          if [ $css_size -gt 100000 ]; then
            echo "âš ï¸  CSS size > 100KB - Consider minification"
          else
            echo "âœ… CSS size is good"
          fi

          if [ $js_size -gt 100000 ]; then
            echo "âš ï¸  JS size > 100KB - Consider minification"
          else
            echo "âœ… JavaScript size is good"
          fi

  # 3. ë°°í¬ ìƒíƒœ ì•Œë¦¼
  notify-status:
    name: ğŸ“¢ Deployment Status
    runs-on: ubuntu-latest
    needs: [build-and-deploy, performance-check]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: ğŸ‰ Success Notification
        if: needs.build-and-deploy.result == 'success'
        run: |
          echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
          echo "ğŸ“Š Modern Spreadsheetê°€ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ğŸŒ ë°°í¬ëœ ì‚¬ì´íŠ¸:"
          echo "   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo ""
          echo "ğŸ“‹ ë°°í¬ ì •ë³´:"
          echo "   Repository: ${{ github.repository }}"
          echo "   Branch: ${{ github.ref_name }}"
          echo "   Commit: ${{ github.sha }}"
          echo "   Actor: ${{ github.actor }}"
          echo ""
          echo "âœ¨ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì¦ê²ê²Œ ì‚¬ìš©í•˜ì„¸ìš”!"

      - name: âŒ Failure Notification
        if: needs.build-and-deploy.result == 'failure'
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          echo "ğŸ” ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”:"
          echo "   1. index.html, styles.css, app.js íŒŒì¼ì´ ëª¨ë‘ ìˆëŠ”ì§€"
          echo "   2. HTMLì—ì„œ CSSì™€ JS íŒŒì¼ì´ ì˜¬ë°”ë¥´ê²Œ ë§í¬ë˜ì–´ ìˆëŠ”ì§€"
          echo "   3. íŒŒì¼ ê²½ë¡œì™€ ì´ë¦„ì´ ì •í™•í•œì§€"
          echo ""
          echo "ğŸ“– ìì„¸í•œ ì˜¤ë¥˜ ë‚´ìš©ì€ Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."

      - name: âš ï¸ Partial Success
        if: needs.build-and-deploy.result == 'success' && needs.performance-check.result == 'failure'
        run: |
          echo "âš ï¸ ë°°í¬ëŠ” ì„±ê³µí–ˆì§€ë§Œ ì„±ëŠ¥ ì²´í¬ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          echo "ğŸŒ ì‚¬ì´íŠ¸ëŠ” ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ì§€ë§Œ, ì„±ëŠ¥ì„ ê°œì„ í•´ë³´ì„¸ìš”."
