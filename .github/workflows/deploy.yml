name: ğŸš€ Deploy Modern Spreadsheet

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  # main ë¸Œëœì¹˜ì— pushë  ë•Œ
  push:
    branches: [main, master]

  # Pull Requestê°€ main ë¸Œëœì¹˜ë¡œ ì˜¬ ë•Œ
  pull_request:
    branches: [main, master]

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  NODE_VERSION: "18"
  DEPLOY_BRANCH: "gh-pages"

# Job ì •ì˜
jobs:
  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë° í…ŒìŠ¤íŠ¸
  quality-check:
    name: ğŸ” Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: |
          npm init -y
          npm install --save-dev eslint prettier htmlhint stylelint

      - name: ğŸ¨ Check HTML syntax
        run: |
          npx htmlhint index.html
        continue-on-error: true

      - name: ğŸ¯ Check CSS syntax
        run: |
          npx stylelint styles.css
        continue-on-error: true

      - name: âš¡ Check JavaScript syntax
        run: |
          npx eslint app.js
        continue-on-error: true

  # 2. ë¹Œë“œ ë° ìµœì í™”
  build:
    name: ğŸ—ï¸ Build & Optimize
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install build tools
        run: |
          npm init -y
          npm install --save-dev html-minifier clean-css-cli terser

      - name: ğŸ—œï¸ Minify HTML
        run: |
          npx html-minifier --collapse-whitespace --remove-comments --minify-css --minify-js index.html -o dist/index.html

      - name: ğŸ—œï¸ Minify CSS
        run: |
          mkdir -p dist
          npx cleancss -o dist/styles.min.css styles.css

      - name: ğŸ—œï¸ Minify JavaScript
        run: |
          npx terser app.js -o dist/app.min.js --compress --mangle

      - name: ğŸ“ Update file references
        run: |
          sed -i 's/styles\.css/styles.min.css/g' dist/index.html
          sed -i 's/app\.js/app.min.js/g' dist/index.html

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/
          retention-days: 30

  # 3. ë°°í¬ (main ë¸Œëœì¹˜ë§Œ)
  deploy:
    name: ğŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    # GitHub Pages ë°°í¬ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: read
      pages: write
      id-token: write

    # ë°°í¬ í™˜ê²½ ì„¤ì •
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: ./dist

      - name: ğŸ“‹ Copy original files for fallback
        run: |
          cp index.html dist/
          cp styles.css dist/
          cp app.js dist/

      - name: ğŸ“„ Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # 4. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ì„ íƒì )
  performance-test:
    name: ğŸ“Š Performance Test
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: ğŸš¦ Run Lighthouse CI
        run: |
          lhci autorun --upload.target=temporary-public-storage
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # 5. ì•Œë¦¼ (ì„ íƒì )
  notify:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [deploy, performance-test]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: ğŸ‰ Success Notification
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ ë°°í¬ ì„±ê³µ! ìŠ¤í”„ë ˆë“œì‹œíŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

      - name: âŒ Failure Notification
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
